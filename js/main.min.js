// Optimized main.js - maintains functionality but improves performance
// Page loader - optimized animation
window.addEventListener('load', () => {
  // Use RAF for smoother animation
  requestAnimationFrame(() => {
    const loader = document.querySelector('.loader');
    if (loader) {
      loader.classList.add('hidden');
      // Remove loader from DOM after animation completes to free resources
      setTimeout(() => {
        loader.style.display = 'none';
      }, 1000);
    }
  });
});

// Mobile menu toggle - with optimized event handling
const menuToggle = document.querySelector('.menu-toggle');
const navbar = document.querySelector('.navbar');

if (menuToggle && navbar) {
  menuToggle.addEventListener('click', () => {
    menuToggle.classList.toggle('active');
    navbar.classList.toggle('active');
  });
  
  // Use event delegation instead of multiple listeners
  navbar.addEventListener('click', (e) => {
    if (e.target.tagName === 'A' || e.target.parentElement.tagName === 'A') {
      navbar.classList.remove('active');
      menuToggle.classList.remove('active');
    }
  });
}

// Optimized page transitions
document.addEventListener('click', (e) => {
  const link = e.target.closest('a:not([target="_blank"]):not([href^="#"])');
  
  if (link) {
    const href = link.getAttribute('href');
    if (!href) return;
    
    e.preventDefault();
    
    const transition = document.querySelector('.page-transition');
    if (transition) {
      transition.style.transform = 'translateY(0)';
      
      // Shorter transition for better responsiveness
      setTimeout(() => {
        window.location.href = href;
      }, 600);
    } else {
      window.location.href = href;
    }
  }
});

// Smooth scroll for anchor links - optimized with delegation
document.addEventListener('click', (e) => {
  const anchor = e.target.closest('a[href^="#"]');
  if (!anchor) return;
  
  e.preventDefault();
  
  const targetId = anchor.getAttribute('href');
  if (targetId === '#') return;
  
  const targetElement = document.querySelector(targetId);
  if (!targetElement) return;
  
  // Close mobile menu if open
  if (navbar) navbar.classList.remove('active');
  if (menuToggle) menuToggle.classList.remove('active');
  
  // Use modern scrollIntoView with smooth behavior
  // This is more performant than manually calculating scroll position
  targetElement.scrollIntoView({
    behavior: 'smooth',
    block: 'start',
    inline: 'nearest'
  });
});

// Throttled scroll handler for better performance
let lastScrollTime = 0;
const scrollThrottle = 100; // ms between scroll event handling

function throttledScroll() {
  const now = performance.now();
  if (now - lastScrollTime >= scrollThrottle) {
    lastScrollTime = now;
    
    // Header scroll effect
    const header = document.querySelector('header');
    if (header) {
      if (window.scrollY > 100) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    }
    
    // Use IntersectionObserver for more efficient section appearance
    handleSectionAppearance();
  }
}

// Use passive event listener for scroll to prevent blocking
window.addEventListener('scroll', throttledScroll, { passive: true });

// More efficient section animations using IntersectionObserver
function setupSectionObservers() {
  if ('IntersectionObserver' in window) {
    const sectionObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('appear');
          // Once section has appeared, no need to observe it anymore
          sectionObserver.unobserve(entry.target);
        }
      });
    }, {
      rootMargin: '0px 0px -100px 0px', // Trigger slightly before section enters viewport
      threshold: 0.1 // Trigger when 10% of section is visible
    });
    
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => {
      sectionObserver.observe(section);
    });
    
    return true;
  }
  return false;
}

// Fallback for browsers without IntersectionObserver
function handleSectionAppearance() {
  if (!('IntersectionObserver' in window)) {
    const sections = document.querySelectorAll('.section:not(.appear)');
    sections.forEach(section => {
      const rect = section.getBoundingClientRect();
      if (rect.top < window.innerHeight - 100) {
        section.classList.add('appear');
      }
    });
  }
}

// Contact form handler with better UX
const contactForm = document.getElementById('contactForm');
if (contactForm) {
  const formMessage = document.getElementById('formMessage');
  
  contactForm.addEventListener('submit', function(e) {
    // Show sending message
    if (formMessage) {
      showMessage('Sending message...', 'info');
    }
  });
  
  // Check URL params for form submission status
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('submission') && urlParams.get('submission') === 'success') {
    showMessage('Thank you for your message! I will get back to you soon.', 'success');
    // Clean URL
    history.replaceState({}, document.title, window.location.pathname);
  }
  
  function showMessage(text, type) {
    if (!formMessage) return;
    
    formMessage.textContent = text;
    formMessage.className = 'form-message';
    formMessage.classList.add(type);
    formMessage.style.display = 'block';
    
    // Hide message after 5 seconds
    setTimeout(() => {
      formMessage.style.display = 'none';
    }, 5000);
  }
}

// Active navigation management with throttling
let activeNavLastUpdate = 0;
const activeNavThrottle = 200; // ms

function updateActiveNavigation() {
  const now = performance.now();
  if (now - activeNavLastUpdate < activeNavThrottle) return;
  activeNavLastUpdate = now;
  
  const sections = document.querySelectorAll('section[id]');
  const navItems = document.querySelectorAll('.nav-item');
  
  if (!sections.length || !navItems.length) return;
  
  let currentSection = '';
  const scrollPosition = window.scrollY + 150;
  
  sections.forEach(section => {
    const sectionTop = section.offsetTop;
    const sectionHeight = section.offsetHeight;
    
    if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
      currentSection = section.getAttribute('id');
    }
  });
  
  navItems.forEach(item => {
    item.classList.remove('active');
    if (item.getAttribute('href') === `#${currentSection}`) {
      item.classList.add('active');
    }
  });
}

// Use passive scroll listener for navigation updates
window.addEventListener('scroll', updateActiveNavigation, { passive: true });

// Initialize everything on DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // Try to use IntersectionObserver, fall back if not available
  const usingObserver = setupSectionObservers();
  if (!usingObserver) {
    handleSectionAppearance();
  }
  
  // Set initial active navigation
  updateActiveNavigation();
});
