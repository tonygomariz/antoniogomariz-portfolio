// Optimized gallery.js
document.addEventListener('DOMContentLoaded',function(){const carousel=document.querySelector('.carousel');if(!carousel)return;const allImages=Array.from(document.querySelectorAll('.carousel-image'));const leftBtn=document.querySelector('.left-btn');const rightBtn=document.querySelector('.right-btn');const lightbox=document.getElementById('lightbox');const lightboxImg=document.getElementById('lightbox-img');const closeBtn=document.querySelector('.close-lightbox');const prevBtn=document.querySelector('.prev-btn');const nextBtn=document.querySelector('.next-btn');const filterSelect=document.getElementById('filter');const imageCounter=document.querySelector('.image-counter');if(!allImages.length||!lightbox||!lightboxImg)return;let currentIndex=0;let scale=1;function preloadAdjacentImages(){const visibleImages=getVisibleImages();if(visibleImages.length===0)return;const nextIndex=(currentIndex+1)%visibleImages.length;if(visibleImages[nextIndex].hasAttribute('data-src')){const nextImg=new Image();nextImg.src=visibleImages[nextIndex].getAttribute('data-src');}
const prevIndex=(currentIndex-1+visibleImages.length)%visibleImages.length;if(visibleImages[prevIndex].hasAttribute('data-src')){const prevImg=new Image();prevImg.src=visibleImages[prevIndex].getAttribute('data-src');}}
function getVisibleImages(){return allImages.filter(img=>img.style.display!=='none');}
let cachedItemWidth=0;let lastWidth=window.innerWidth;function getItemWidth(){if(window.innerWidth===lastWidth&&cachedItemWidth>0){return cachedItemWidth;}
const visibleImages=getVisibleImages();if(visibleImages.length===0)return 0;const firstImage=visibleImages[0];const style=window.getComputedStyle(firstImage);const marginLeft=parseInt(style.marginLeft)||0;const marginRight=parseInt(style.marginRight)||0;lastWidth=window.innerWidth;cachedItemWidth=firstImage.offsetWidth+marginLeft+marginRight;return cachedItemWidth;}
function getImagesPerView(){const width=window.innerWidth;if(width>=1200)return 3;if(width>=768)return 2;return 1;}
let isTransforming=false;function updateCarouselTransform(){if(isTransforming)return;const visibleImages=getVisibleImages();if(visibleImages.length===0)return;const itemWidth=getItemWidth();const position=-currentIndex*itemWidth;isTransforming=true;requestAnimationFrame(()=>{carousel.style.transition="transform 0.4s ease-in-out";carousel.style.transform=`translateX(${position}px)`;setTimeout(()=>{isTransforming=false;preloadAdjacentImages();},400);});}
let resizeTimeout;function debouncedUpdate(){clearTimeout(resizeTimeout);resizeTimeout=setTimeout(()=>{cachedItemWidth=0;updateCarouselTransform();},150);}
function nextSlide(){const visibleImages=getVisibleImages();if(visibleImages.length===0||isTransforming)return;currentIndex=(currentIndex+1)%visibleImages.length;updateCarouselTransform();}
function prevSlide(){const visibleImages=getVisibleImages();if(visibleImages.length===0||isTransforming)return;currentIndex=(currentIndex-1+visibleImages.length)%visibleImages.length;updateCarouselTransform();}
if(leftBtn)leftBtn.addEventListener('click',prevSlide,{passive:true});if(rightBtn)rightBtn.addEventListener('click',nextSlide,{passive:true});if(carousel){carousel.addEventListener('click',(event)=>{const target=event.target;if(target.classList.contains('carousel-image')&&target.style.display!=='none'){const visibleImages=getVisibleImages();const index=visibleImages.indexOf(target);if(index!==-1){currentIndex=index;updateCarouselTransform();openLightbox();}}},{passive:true});}
function openLightbox(){const visibleImages=getVisibleImages();if(visibleImages.length===0)return;lightboxImg.style.transform='scale(1)';scale=1;const scrollY=window.scrollY;document.body.style.position='fixed';document.body.style.top=`-${scrollY}px`;document.body.style.width='100%';document.body.style.overflowY='scroll';lightbox.style.display='flex';lightbox.style.opacity='0';const targetImage=visibleImages[currentIndex];lightboxImg.src=targetImage.getAttribute('data-src')||targetImage.src;lightboxImg.alt=targetImage.alt;requestAnimationFrame(()=>{lightbox.style.opacity='1';updateCounter();});}
function updateCounter(){const visibleImages=getVisibleImages();if(!imageCounter||visibleImages.length===0)return;imageCounter.textContent=`${currentIndex+1} / ${visibleImages.length}`;}
function navigateLightbox(direction){const visibleImages=getVisibleImages();if(visibleImages.length===0)return;lightboxImg.style.opacity='0.5';if(direction==='next'){currentIndex=(currentIndex+1)%visibleImages.length;}else{currentIndex=(currentIndex-1+visibleImages.length)%visibleImages.length;}
updateCarouselTransform();const targetImage=visibleImages[currentIndex];const imageSrc=targetImage.getAttribute('data-src')||targetImage.src;lightboxImg.src=imageSrc;lightboxImg.alt=targetImage.alt;updateCounter();setTimeout(()=>{lightboxImg.style.opacity='1';},100);}
function closeLightbox(){lightbox.style.opacity='0';const scrollY=parseInt(document.body.style.top||'0')*-1;document.body.style.position='';document.body.style.top='';document.body.style.width='';document.body.style.overflowY='';window.scrollTo(0,scrollY);setTimeout(()=>{lightbox.style.display='none';},300);}
if(closeBtn)closeBtn.addEventListener('click',closeLightbox,{passive:true});if(prevBtn)prevBtn.addEventListener('click',(e)=>{e.stopPropagation();navigateLightbox('prev');},{passive:false});if(nextBtn)nextBtn.addEventListener('click',(e)=>{e.stopPropagation();navigateLightbox('next');},{passive:false});if(filterSelect){filterSelect.addEventListener('change',function(){const selected=filterSelect.value;requestAnimationFrame(()=>{allImages.forEach(img=>{if(selected==='all'||img.classList.contains(selected)){img.style.display='block';}else{img.style.display='none';}});currentIndex=0;updateCarouselTransform();});},{passive:true});}
document.addEventListener('keydown',(event)=>{if(lightbox&&lightbox.style.display==='flex'){if(event.key==='Escape'){closeLightbox();}else if(event.key==='ArrowLeft'){navigateLightbox('prev');}else if(event.key==='ArrowRight'){navigateLightbox('next');}}},{passive:true});function initGallery(){carousel.style.transition='none';carousel.style.transform='translateX(0)';void carousel.offsetWidth;setTimeout(()=>{carousel.style.transition='';},50);window.addEventListener('resize',debouncedUpdate,{passive:true});updateCarouselTransform();}
initGallery();});